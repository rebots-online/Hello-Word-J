# Core Services - 2025-06-21 13:15:00

This document outlines the core services implemented: `LiturgicalCalendar`, `TextService`, and `DataManager`.

## 1. LiturgicalCalendar Service (`src/core/services/calendarService.ts`)

- **Purpose:** Provides information about liturgical days.
- **Key Components:**
    - `LiturgicalDay` (interface from `core/types/liturgical.ts`): Defines the structure for a liturgical day's data.
    - `LiturgicalSeason` (enum from `core/types/liturgical.ts`): Defines possible liturgical seasons.
    - `LiturgicalCalendar` (class):
        - `static async getDayInfo(dateString: string): Promise<LiturgicalDay>`:
            - Takes a date string (e.g., "YYYY-MM-DD").
            - Returns a `LiturgicalDay` object containing details like season, celebration, rank, color, and commemorations.
            - Currently contains basic placeholder logic for determining seasons and a specific hardcoded entry for "2025-06-21" as requested.
            - **Note:** The season calculation logic is highly simplified and needs to be replaced with a robust algorithm for accurate liturgical calendar calculations (e.g., Computus for Easter, rules for fixed and movable feasts).

## 2. TextService (`src/core/services/textService.ts`)

- **Purpose:** Retrieves liturgical texts (e.g., Mass Propers, Office readings).
- **Key Components:**
    - `BilingualText` (interface from `core/types/liturgical.ts`): Defines the structure for texts presented in Latin and English. Fields: `latin`, `english`, `isRubric?`.
    - `IStorageService` (interface from `core/types/services.ts`): Dependency injected for database access.
    - `TextService` (class):
        - `constructor(storageService: IStorageService)`: Takes an `IStorageService` instance.
        - `async getMassProper(date: string): Promise<BilingualText[]>`:
            - Takes a date string.
            - Intended to query the database (via `IStorageService`) to fetch Mass Propers for the given date's celebration.
            - Currently returns placeholder data, including specific data for "2025-06-21".
            - The actual SQL query structure is commented out and will depend on the final database schema and how celebrations are keyed.

## 3. DataManager Service (`src/core/services/dataManager.ts`)

- **Purpose:** Manages database schema initialization and provides a higher-level interface for data operations.
- **Key Components:**
    - `IStorageService` (interface from `core/types/services.ts`): Dependency injected for raw database operations.
    - `LiturgicalDay` (imported from `core/types/liturgical.ts`).
    - `DataManager` (class):
        - `constructor(storageService: IStorageService)`: Takes an `IStorageService` instance.
        - `SQL Constants`: Defines `CREATE TABLE IF NOT EXISTS` statements for:
            - `calendar_days`: Stores information about each liturgical day.
            - `mass_texts`: Stores texts for Mass parts, linked to celebrations.
            - `office_texts`: Stores texts for Divine Office parts, linked to celebrations.
            - `voice_notes`: Stores metadata for user voice journal entries.
        - `async initialize(): Promise<void>`:
            - Calls the `initialize()` method of the injected `storageService`.
            - Executes the `CREATE TABLE` statements within a transaction to ensure atomicity.
        - `async addCalendarDay(day: LiturgicalDay): Promise<void>` (Example method):
            - Illustrates how data might be inserted into the `calendar_days` table using the `LiturgicalDay` type.
            - **Note:** `celebration_key` in `mass_texts` and `office_texts` currently suggests a direct link to `calendar_days.date`. This might need refinement, perhaps with a separate `celebrations` table if a single day can have multiple distinct liturgical events or if celebration details are complex. Commemorations in `calendar_days` are stored as a JSON string.

## Relationships and Flow (Mermaid Diagram)

```mermaid
graph TD
    subgraph CoreServices
        A[LiturgicalCalendar]
        B[TextService]
        C[DataManager]
    end

    subgraph CoreTypes
        D[types/liturgical.ts]
        E[types/services.ts]
    end

    subgraph PlatformAbstractions
        F[IStorageService]
    end

    A -- uses --> D;
    B -- uses --> D;
    B -- depends on --> F;
    C -- depends on --> F;
    C -- uses --> D; %% DataManager uses LiturgicalDay from liturgical.ts
    C -- uses --> E; %% DataManager uses IStorageService from services.ts


    UI_Layer --> A;
    UI_Layer --> B;
    App_Initialization --> C;

    C -- initializes schema in --> DB[(Database)];
    F -- abstracts interaction with --> DB;
    B -- reads from --> DB;

    %% Specific Method Calls
    A_GI[getDayInfo] --> D_LD{LiturgicalDay};
    B_GMP[getMassProper] --> D_BT{BilingualText Array};
    C_Init[initialize] --> F_ExecQ1[executeQuery CREATE_CALENDAR_DAYS_TABLE];
    C_Init --> F_ExecQ2[executeQuery CREATE_MASS_TEXTS_TABLE];
    C_Init --> F_ExecQ3[executeQuery CREATE_OFFICE_TEXTS_TABLE];
    C_Init --> F_ExecQ4[executeQuery CREATE_VOICE_NOTES_TABLE];

    classDef service fill:#f9f,stroke:#333,stroke-width:2px;
    classDef type fill:#ccf,stroke:#333,stroke-width:2px;
    classDef interface fill:#lightgrey,stroke:#333,stroke-width:2px;
    classDef db fill:#tan,stroke:#333,stroke-width:2px;

    class A,B,C service;
    class D,E type;
    class F interface;
    class DB db;
```

## Changes from Stipulated Structure (and self-corrections)

- The implementations are currently placeholders, especially the liturgical calculation logic in `LiturgicalCalendar` and the data fetching in `TextService`. These will require significant expansion.
- The database schema in `DataManager` is an initial proposal and may evolve as data import from Divinum Officium sources begins and specific query requirements become clearer.
- The `addCalendarDay` method in `DataManager` correctly imports and uses the `LiturgicalDay` type.
- The `BilingualText` interface in `core/types/liturgical.ts` correctly only includes `latin`, `english`, and `isRubric?` as per Task A.4.
- The `transaction` method is expected on `IStorageService` due to its use in `DataManager` for atomic schema initialization. This is good practice.
- The `LiturgicalDay` type and `LiturgicalCalendar.getDayInfo` were adapted to include `rank`, `color`, and `commemorations` to align with the example output for June 21, 2025.
